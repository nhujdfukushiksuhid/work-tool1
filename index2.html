<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯æ´è¨ˆç”»ä½œæˆAI - Ver.6.0 Narrative</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* --- Design System: Orange & Green (Warmth, Growth, Security) --- */
        :root {
            --primary: #f97316;       /* Orange 500 */
            --primary-dark: #c2410c;  
            --primary-light: #fff7ed; 
            
            --accent: #10b981;        /* Emerald 500 */
            --accent-dark: #047857;   
            --accent-light: #ecfdf5;  

            --bg-body: #f1f5f9;       
            --surface: #ffffff;
            --text-main: #334155;     
            --text-muted: #64748b;    
            --border: #cbd5e1;

            --radius: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.05);
        }

        /* Base */
        * { box-sizing: border-box; }
        body {
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; padding: 0;
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }

        /* Header */
        header { text-align: center; margin-bottom: 40px; }
        h1 {
            font-size: 2.2rem; color: var(--text-main); margin: 0 0 16px 0;
            display: inline-flex; align-items: center; gap: 12px; letter-spacing: -0.05em;
        }
        .tag-ver {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; font-size: 0.9rem; padding: 4px 12px; border-radius: 99px;
            vertical-align: middle; box-shadow: 0 2px 4px rgba(249, 115, 22, 0.3);
        }
        .subtitle { color: var(--text-muted); margin-bottom: 24px; }

        .security-alert {
            background-color: var(--accent-light);
            border: 2px solid var(--accent);
            color: var(--accent-dark);
            display: inline-flex; align-items: center; gap: 12px;
            padding: 12px 30px; border-radius: 50px;
            font-weight: bold; margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.1);
        }
        .security-icon { font-size: 1.4rem; }

        /* Logic Cards */
        .logic-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin-bottom: 40px;
        }
        .logic-card {
            background: var(--surface); padding: 24px; border-radius: var(--radius);
            box-shadow: var(--shadow); border: 1px solid var(--border);
            position: relative; overflow: hidden;
        }
        .logic-card::before {
            content: ''; position: absolute; top:0; left:0; width:6px; height:100%;
            background: var(--primary);
        }
        .logic-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 8px; color: var(--text-main); }
        .logic-desc { font-size: 0.9rem; color: var(--text-muted); }

        /* Drop Zone */
        .drop-wrapper {
            background: var(--surface); padding: 10px; border-radius: var(--radius);
            box-shadow: var(--shadow); margin-bottom: 30px;
        }
        .drop-zone {
            border: 3px dashed #cbd5e1; border-radius: 8px; padding: 60px 20px;
            background: #f8fafc; cursor: pointer; text-align: center;
            transition: all 0.3s ease;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--primary); background: var(--primary-light); transform: scale(1.005);
        }
        .drop-title { font-size: 1.5rem; font-weight: bold; color: var(--text-main); margin-bottom: 8px; }

        /* Result Area */
        .control-panel {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--surface); padding: 20px 30px; border-radius: var(--radius);
            box-shadow: var(--shadow); margin-bottom: 20px; flex-wrap: wrap; gap: 16px;
        }
        .stat { font-weight: bold; font-size: 1.1rem; }
        .stat span { color: var(--accent); font-size: 1.5rem; margin-left: 8px; }

        .btn-group { display: flex; gap: 12px; }
        button {
            border: none; padding: 12px 24px; border-radius: 50px; font-weight: bold;
            cursor: pointer; display: flex; align-items: center; gap: 8px;
            transition: all 0.2s; font-size: 0.95rem;
        }
        .btn-main { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); }
        .btn-main:hover { transform: translateY(-2px); background: var(--accent-dark); }
        .btn-sub { background: white; border: 2px solid var(--border); color: var(--text-main); }
        .btn-sub:hover { background: var(--bg-body); }

        /* Table */
        .table-wrap {
            overflow-x: auto; background: var(--surface); border-radius: var(--radius);
            box-shadow: var(--shadow); border: 1px solid var(--border);
        }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; white-space: normal; }
        th {
            background: #f1f5f9; padding: 16px; text-align: left; font-weight: bold;
            color: var(--text-main); border-bottom: 2px solid #cbd5e1;
            position: sticky; top: 0; z-index: 10;
        }
        td { padding: 16px; border-bottom: 1px solid var(--border); vertical-align: top; font-size: 0.9rem; }
        
        .col-life { background-color: #fffbeb; }
        .col-work { background-color: #f0fdf4; }
        .col-future { background-color: #eff6ff; }

        /* Status Badges */
        .badge {
            display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 800; color: white; margin-right: 4px;
        }
        .badge-A { background: #3b82f6; } .badge-B { background: #ef4444; }
        .badge-C { background: #f59e0b; } .badge-D { background: #10b981; }
        
        .badge-high { background: #10b981; border: 1px solid #059669; color: #fff; } /* Stable/Good */
        .badge-low { background: #f59e0b; border: 1px solid #d97706; color: #fff; } /* Needs Support */

        /* Loader */
        .overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .overlay.active { opacity: 1; pointer-events: auto; }
        .spinner {
            width: 50px; height: 50px; border: 5px solid var(--primary-light);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸŒ± æ”¯æ´è¨ˆç”»ä½œæˆAI <span class="tag-ver">Ver.6.0 Narrative</span></h1>
        <p class="subtitle">ã€Œã§ãã¦ã„ã‚‹äººã€ã«ã¯ã€Œä¼¸ã°ã™ã€ææ¡ˆã‚’ã€‚ã€Œèª²é¡ŒãŒã‚ã‚‹äººã€ã«ã¯ã€Œæ”¯ãˆã‚‹ã€ææ¡ˆã‚’ã€‚</p>
        
        <div class="security-alert">
            <span class="security-icon">ğŸ”’</span>
            <span>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æœ€å¼·ï¼šãƒ‡ãƒ¼ã‚¿ã¯å¤–éƒ¨ã«ä¸€åˆ‡é€ä¿¡ã•ã‚Œãšã€ã‚ãªãŸã®PCå†…ã ã‘ã§å®Œçµã—ã¾ã™</span>
        </div>
    </header>

    <div class="logic-grid">
        <div class="logic-card">
            <div class="logic-title">ğŸ“Š ãƒã‚¸ãƒã‚¬åˆ†æ (Context)</div>
            <div class="logic-desc">æ—¥å ±ã‹ã‚‰ã€Œå®‰å®šã€ã€Œä¸èª¿ã€ã‚’åˆ¤å®šã€‚ã§ãã¦ã„ã‚‹äººã«ã€Œã§ãã‚‹ã‚ˆã†ã«ãªã‚ã†ã€ã¨ã„ã†é “çæ¼¢ãªææ¡ˆã‚’é˜²ãã¾ã™ã€‚</div>
        </div>
        <div class="logic-card">
            <div class="logic-title">ğŸ° å…¨é …ç›®ã‚¹ãƒ­ãƒƒãƒˆç”Ÿæˆ (Variety)</div>
            <div class="logic-desc">æ–¹é‡ãƒ»é•·æœŸãƒ»çŸ­æœŸç›®æ¨™ã‚‚å«ã‚ã€ã™ã¹ã¦ã®é …ç›®ã§æ•°åƒãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ–‡ç« ã‚’ç”Ÿæˆã€‚ã‹ã¶ã‚Šã‚’å¾¹åº•æ’é™¤ã—ã¾ã™ã€‚</div>
        </div>
        <div class="logic-card">
            <div class="logic-title">ğŸ›¡ï¸ å®Œå…¨ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç† (Security)</div>
            <div class="logic-desc">AIã¨ã„ã£ã¦ã‚‚ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã¯ç¹‹ãŒã‚Šã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ä¸­ã§å‹•ããƒ—ãƒ­ã‚°ãƒ©ãƒ ãªã®ã§ã€æ©Ÿå¯†æƒ…å ±ã‚‚å®‰å…¨ã§ã™ã€‚</div>
        </div>
    </div>

    <div class="drop-wrapper">
        <div id="dropZone" class="drop-zone">
            <div class="drop-title">Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
            <div style="color:var(--text-muted);">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ (.xlsx / .xls)</div>
            <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none">
        </div>
    </div>

    <div id="resultArea" class="hidden fade-in">
        <div class="control-panel">
            <div class="stat">ç”Ÿæˆå®Œäº†: <span id="countDisplay">0</span> å</div>
            <div class="btn-group">
                <button class="btn-sub" id="retryBtn">ğŸ² å…¨å“¡æ›¸ãç›´ã™</button>
                <button class="btn-sub" id="copyBtn">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                <button class="btn-main" id="downloadBtn">ğŸ’¾ CSVä¿å­˜</button>
            </div>
        </div>

        <div class="table-wrap">
            <table id="resultTable">
                <thead>
                    <tr>
                        <th style="min-width:140px;">å¯¾è±¡è€…å</th>
                        <th style="min-width:120px;">åˆ†æçµæœ</th>
                        <th style="min-width:320px;">ç·åˆçš„ãªæ”¯æ´æ–¹é‡</th>
                        <th style="min-width:280px;">é•·æœŸç›®æ¨™</th>
                        <th style="min-width:280px;">çŸ­æœŸç›®æ¨™</th>
                        <th style="min-width:260px;" class="col-life">ç›®æ¨™1 (ç”Ÿæ´»)</th>
                        <th style="min-width:260px;" class="col-life">æ”¯æ´1</th>
                        <th style="min-width:260px;" class="col-work">ç›®æ¨™2 (ä½œæ¥­)</th>
                        <th style="min-width:260px;" class="col-work">æ”¯æ´2</th>
                        <th style="min-width:260px;" class="col-future">ç›®æ¨™3 (å°±åŠ´)</th>
                        <th style="min-width:260px;" class="col-future">æ”¯æ´3</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="loadingOverlay" class="overlay">
    <div class="spinner"></div>
    <h3 style="margin-top:20px; color:var(--text-main);">AIãŒæ–‡ç« ã‚’æ§‹æˆä¸­...</h3>
    <p style="color:var(--text-muted);">æ–¹é‡ãƒ»ç›®æ¨™ãƒ»æ”¯æ´ã®å…¨é …ç›®ã‚’ç‹¬è‡ªç”Ÿæˆã—ã¦ã„ã¾ã™</p>
</div>

<script>
/**
 * Ver 6.0 Logic Engine: Grand Narrative
 * æ–¹é‡ãƒ»é•·æœŸãƒ»çŸ­æœŸç›®æ¨™ã‚‚å«ã‚ãŸã€Œå…¨é …ç›®ã€ã®ç”Ÿæˆãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ¥µå¤§åŒ–ã€‚
 */

// --- 1. Analysis Keywords ---
const KEYWORDS = {
    types: {
        A: ['PC','å…¥åŠ›','å°±è·','ä»•äº‹','ã‚¹ã‚­ãƒ«','è³‡æ ¼','å®Ÿç¿’','æ±‚äºº','Word','Excel'],
        B: ['ä½“èª¿','ç—…é™¢','è–¬','ä¼‘ã¿','é…åˆ»','ä¸èª¿','é€šé™¢','ä¸å®‰','ã—ã‚“ã©ã„','çœ æ°—'],
        C: ['ä¼šè©±','ãƒˆãƒ©ãƒ–ãƒ«','æ€’','å£°','ç›¸è«‡','æ„Ÿæƒ…','ä»–å®³','ã‚¤ãƒ©ã‚¤ãƒ©','å–§å˜©'],
        D: ['æœ','æŒ¨æ‹¶','å¿˜ã‚Œ','ç‰‡ä»˜ã‘','æƒé™¤','ãƒ«ãƒ¼ãƒ«','é¢¨å‘‚','æ­¯ç£¨ã','é‡‘éŠ­']
    },
    sentiment: {
        positive: ['ã§ããŸ','å®‰å®š','è‰¯å¥½','æ„æ¬²','ç¬‘é¡”','é›†ä¸­','é †èª¿','å•é¡Œãªã','ä¸å¯§','æ—©ã„','æ­£ç¢º','å‚åŠ ','æ¥½ã—','çš†å‹¤'],
        negative: ['ä¼‘ã¿','é…åˆ»','æ—©é€€','ä¸èª¿','ãƒˆãƒ©ãƒ–ãƒ«','èˆˆå¥®','æ‹’å¦','å¿˜ã‚Œ','ãƒŸã‚¹','æ³¨æ„','ä¸­æ–­','å¸°å®…','åœæ­¢','ä¸å®‰å®š']
    }
};

// --- 2. Narrative Vocabulary (Updated for Grand Variety) ---
const VOCAB = {
    // å…±é€šéƒ¨å“
    openers: [
        "ã¾ãšã¯", "æ—¥ã€…ã®æ´»å‹•ã‚’é€šã˜ã¦", "æœ¬äººã®ãƒšãƒ¼ã‚¹ã‚’å¤§åˆ‡ã«ã—", "ç¾åœ¨ã®çŠ¶æ³ã‚’è¸ã¾ãˆ", 
        "å°†æ¥çš„ãªå±•æœ›ã‚’è¦‹æ®ãˆ", "ã”æœ¬äººã®æ„å‘ã‚’å°Šé‡ã—", "ç’°å¢ƒã®å¤‰åŒ–ã«åˆã‚ã›", 
        "æœ¬äººã®å¼·ã¿ã‚’æ´»ã‹ã™ãŸã‚", "é•·æœŸçš„ãªè¦–ç‚¹ã«ç«‹ã¡", "æ—¥é ƒã®æ§˜å­ã‹ã‚‰", 
        "å®‰å®šã—ãŸåŸºç›¤ã®ä¸Šã§", "è‡ªä¿¡ã‚’è‚²ã‚€ãŸã‚ã«", "ç€å®Ÿãªã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦"
    ],
    
    // ä¿®é£¾èª (High: Maintain/Enhance, Low: Improve/Support)
    modifiers: {
        high: ["å¼•ãç¶šã", "å®‰å®šã—ã¦", "ä¸»ä½“çš„ã«", "è‡ªä¿¡ã‚’æŒã£ã¦", "ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚’ç™ºæ®ã—", "ã•ã‚‰ã«", "é«˜ã„æ„è­˜ã§", "ç©æ¥µçš„ã«"],
        low:  ["å°‘ã—ãšã¤", "ç€å®Ÿã«", "ç„¦ã‚‰ãš", "æ®µéšçš„ã«", "æ”¯æ´å“¡ã¨å…±ã«", "ã¾ãšã¯", "ä¸å¯§ã«", "ç„¡ç†ãªã"]
    },

    // --- NEW: Narrative Generators for Top 3 Columns ---
    policy: {
        high: [
            "{opener}ã€ç¾åœ¨ã®è‰¯å¥½ãªçŠ¶æ…‹ã‚’{mod}ç¶­æŒã—ã¤ã¤ã€ã•ã‚‰ãªã‚‹ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã‚’ç›®æŒ‡ã™ã€‚",
            "{mod}æ´»å‹•ã§ãã¦ã„ã‚‹å¼·ã¿ã‚’æ´»ã‹ã—ã€{focus}ã¸ã®æŒ‘æˆ¦ã‚’å¾ŒæŠ¼ã—ã™ã‚‹ã€‚",
            "{opener}ã€æœ¬äººã®ä¸»ä½“æ€§ã‚’å°Šé‡ã—ã€{mod}æ´»å‹•ã®å¹…ã‚’åºƒã’ã¦ã„ã‘ã‚‹ã‚ˆã†æ”¯æ´ã™ã‚‹ã€‚",
            "å®‰å®šã—ãŸç”Ÿæ´»ãƒªã‚ºãƒ ã‚’åŸºç›¤ã«ã€{focus}ã«å‘ã‘ãŸå–ã‚Šçµ„ã¿ã‚’{mod}é€²ã‚ã‚‹ã€‚"
        ],
        low: [
            "{opener}ã€å¿ƒèº«ã®å®‰å®šã‚’æœ€å„ªå…ˆã¨ã—ã€{mod}ç”Ÿæ´»ãƒªã‚ºãƒ ã‚’æ•´ãˆã‚‹ã“ã¨ã‹ã‚‰å§‹ã‚ã‚‹ã€‚",
            "èª²é¡Œã¨ãªã£ã¦ã„ã‚‹ç‚¹ã«å¯¾ã—ã€{mod}å‘ãåˆãˆã‚‹ã‚ˆã†ã€æ‰‹åšã„ã‚µãƒãƒ¼ãƒˆã‚’è¡Œã†ã€‚",
            "{opener}ã€å®‰å¿ƒã—ã¦éã”ã›ã‚‹ç’°å¢ƒã‚’æ•´ãˆã€{mod}æ´»å‹•ã«å‚åŠ ã§ãã‚‹ã‚ˆã†æ”¯æ´ã™ã‚‹ã€‚",
            "ã¾ãšã¯{mod}ä¿¡é ¼é–¢ä¿‚ã‚’æ§‹ç¯‰ã—ã€å›°ã‚Šã”ã¨ã‚’ç›¸è«‡ã§ãã‚‹ä½“åˆ¶ã‚’ä½œã‚‹ã€‚"
        ],
        focus: { // Type specific focus
            A: "å°±åŠ´ã«å‘ã‘ãŸå®Ÿè·µçš„ãªã‚¹ã‚­ãƒ«ç¿’å¾—",
            B: "å¿ƒèº«ã®å¥åº·ç®¡ç†ã¨è‡ªå·±ç†è§£",
            C: "å††æ»‘ãªå¯¾äººé–¢ä¿‚ã®æ§‹ç¯‰",
            D: "è‡ªç«‹ã—ãŸæ—¥å¸¸ç”Ÿæ´»ã®ç¢ºç«‹"
        }
    },
    long_goal: {
        high: [
            "{mod}ç¤¾ä¼šç”Ÿæ´»ã‚’é€ã‚Šã€{focus}ã‚’å®Ÿç¾ã™ã‚‹ã€‚",
            "è‡ªèº«ã®å¼·ã¿ã‚’æ´»ã‹ã—ã€{focus}çŠ¶æ…‹ã§æ´»èºã™ã‚‹ã€‚",
            "å‘¨å›²ã‹ã‚‰ä¿¡é ¼ã•ã‚Œã€{mod}{focus}ã§ãã‚‹ã€‚",
            "è‡ªå·±å®Ÿç¾ã«å‘ã‘ã€{mod}ã‚­ãƒ£ãƒªã‚¢ã‚’ç©ã¿é‡ã­ã‚‹ã€‚"
        ],
        low: [
            "å¿ƒèº«å…±ã«å®‰å®šã—ã€{focus}ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚",
            "è‡ªèº«ã®èª²é¡Œã‚’ç†è§£ã—ã€{mod}å¯¾å‡¦ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚",
            "æ”¯æ´ã‚’å—ã‘ãªãŒã‚‰ã€{mod}{focus}ç”Ÿæ´»ã‚’é€ã‚‹ã€‚",
            "å®‰å¿ƒã—ã¦åœ°åŸŸã§æš®ã‚‰ã™ãŸã‚ã®{focus}ã‚’èº«ã«ã¤ã‘ã‚‹ã€‚"
        ],
        focus: {
            A: "ä¸€èˆ¬å°±åŠ´",
            B: "å¥åº·çš„ãªç”Ÿæ´»",
            C: "ç©ã‚„ã‹ãªäººé–“é–¢ä¿‚",
            D: "è‡ªç«‹ã—ãŸç”Ÿæ´»"
        }
    },
    short_goal: {
        high: [
            "æ—¥ã€…ã®æ´»å‹•ã®ä¸­ã§ã€{mod}ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚’ç™ºæ®ã™ã‚‹ã€‚",
            "æ–°ã—ã„èª²é¡Œã«ã‚‚{mod}æŒ‘æˆ¦ã—ã€çµŒé¨“ã‚’ç©ã‚€ã€‚",
            "è‡ªèº«ã®ä½“èª¿ã‚„æ„Ÿæƒ…ã‚’{mod}ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã—ã€ç¶­æŒã™ã‚‹ã€‚",
            "å‘¨å›²ã®æ‰‹æœ¬ã¨ãªã‚‹ã‚ˆã†ãªè¡Œå‹•ã‚’{mod}å¿ƒãŒã‘ã‚‹ã€‚"
        ],
        low: [
            "ã¾ãšã¯{mod}é€šæ‰€ã—ã€ç”Ÿæ´»ã®ãƒªã‚ºãƒ ã‚’ä½œã‚‹ã€‚",
            "å›°ã£ãŸæ™‚ã«ã¯{mod}ç›¸è«‡ã—ã€è§£æ±ºç­–ã‚’ä¸€ç·’ã«è€ƒãˆã‚‹ã€‚",
            "åŸºæœ¬çš„ãªãƒ«ãƒ¼ãƒ«ã‚’{mod}ç†è§£ã—ã€å®ˆã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚",
            "ã‚¹ã‚¿ãƒƒãƒ•ã®åŠ©è¨€ã‚’å—ã‘å…¥ã‚Œã€{mod}ä½œæ¥­ã«å–ã‚Šçµ„ã‚€ã€‚"
        ]
    },

    // --- Individual Goals & Supports (Type Specific) ---
    contents: {
        life: {
            topic: ["èº«ã ã—ãªã¿ã®ä¿æŒ", "è¨ˆç”»çš„ãªé‡‘éŠ­ç®¡ç†", "è‡ªç™ºçš„ãªæŒ¨æ‹¶", "ç”Ÿæ´»ãƒªã‚ºãƒ ã®ç¶­æŒ", "ç¢ºå®Ÿãªæœè–¬ç®¡ç†", "æ•´ç†æ•´é “ã®å¾¹åº•", "æ„ŸæŸ“å¯¾ç­–ã®å®Ÿæ–½"],
            sup:   ["ãƒã‚§ãƒƒã‚¯è¡¨ã§ã®ç¢ºèª", "å‡ºç´å¸³ã®è¨˜å…¥è£œåŠ©", "ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ã®å®Ÿæ–½", "ãƒªã‚ºãƒ è¡¨ã®ç¢ºèª", "é€šé™¢åŒè¡Œ", "æœè–¬ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç¢ºèª", "å£°æ›ã‘"]
        },
        work: {
            topic: ["ä½œæ¥­æ‰‹é †ã®éµå®ˆ", "é›†ä¸­åŠ›ã®æŒç¶š", "è‡ªç™ºçš„ãªå ±é€£ç›¸", "ä¸æ˜ç‚¹ã®è³ªå•", "ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯", "å¾Œç‰‡ä»˜ã‘ã®å¾¹åº•", "ç´æœŸæ„è­˜", "ä¸å¯§ãªè¨€è‘‰é£ã„"],
            sup:   ["æ‰‹é †æ›¸ã®æç¤º", "åº§å¸­é…ç½®ã®èª¿æ•´", "ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®åŠ©è¨€", "è³ªå•ã—ã‚„ã™ã„ç’°å¢ƒä½œã‚Š", "ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆæ´»ç”¨", "ã‚¿ã‚¤ãƒãƒ¼æ”¯æ´", "SSTå®Ÿæ–½"]
        },
        future: {
            topic: ["æ–½è¨­å¤–å°±åŠ´ã§ã®çµŒé¨“", "æ±‚äººæ¤œç´¢", "PCã‚¹ã‚­ãƒ«ã®å‘ä¸Š", "è³‡æ ¼å–å¾—ã¸ã®æŒ‘æˆ¦", "å¿œå‹Ÿæ›¸é¡ã®ä½œæˆ", "é¢æ¥ç·´ç¿’", "ä¼æ¥­å®Ÿç¿’ã¸ã®å‚åŠ "],
            sup:   ["åŒè¡Œæ”¯æ´", "æ¤œç´¢æ©Ÿæ“ä½œè£œåŠ©", "å¿œç”¨èª²é¡Œã®æä¾›", "å­¦ç¿’è¨ˆç”»ç­–å®š", "æ·»å‰ŠæŒ‡å°", "æ¨¡æ“¬é¢æ¥", "å®Ÿç¿’å…ˆèª¿æ•´"]
        }
    },
    
    endings: {
        goal_high: ["ç¶­æŒã™ã‚‹ã€‚", "å‘ä¸Šã•ã›ã‚‹ã€‚", "ç›®æŒ‡ã™ã€‚", "åºƒã’ã¦ã„ãã€‚", "ç¢ºç«‹ã™ã‚‹ã€‚", "ç™ºæ®ã™ã‚‹ã€‚"],
        goal_low:  ["èº«ã«ã¤ã‘ã‚‹ã€‚", "ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚", "ç›®æŒ‡ã™ã€‚", "ç¿’æ…£åŒ–ã™ã‚‹ã€‚", "å–ã‚Šçµ„ã‚€ã€‚", "æ„è­˜ã™ã‚‹ã€‚"],
        sup_high:  ["è©•ä¾¡ã—è‡ªä¿¡ã«ç¹‹ã’ã‚‹ã€‚", "æ›´ãªã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’ä¿ƒã™ã€‚", "ç’°å¢ƒã‚’æ•´ãˆè¦‹å®ˆã‚‹ã€‚", "æœ¬äººã®è‡ªä¸»æ€§ã«ä»»ã›ã‚‹ã€‚"],
        sup_low:   ["æ‰‹åšãã‚µãƒãƒ¼ãƒˆã™ã‚‹ã€‚", "å…·ä½“çš„ã«åŠ©è¨€ã™ã‚‹ã€‚", "ä¸€ç·’ã«ç¢ºèªã‚’è¡Œã†ã€‚", "ç¹°ã‚Šè¿”ã—å£°æ›ã‘ã‚’è¡Œã†ã€‚", "ç’°å¢ƒèª¿æ•´ã‚’è¡Œã†ã€‚"]
    }
};

// --- Global State ---
let lastWorkbook = null;
const generatedHistory = new Set();
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const resultArea = document.getElementById('resultArea');
const loadingOverlay = document.getElementById('loadingOverlay');
const tbody = document.querySelector('#resultTable tbody');

// --- Event Listeners ---
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
    dropZone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
    document.body.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
});
dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', handleDrop);
fileInput.addEventListener('change', (e) => { if(e.target.files[0]) handleFile(e.target.files[0]); });

document.getElementById('retryBtn').addEventListener('click', () => { if(lastWorkbook) renderTable(lastWorkbook); });
document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
document.getElementById('downloadBtn').addEventListener('click', downloadCSV);

// --- Processing ---
function handleDrop(e) {
    dropZone.classList.remove('dragover');
    if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
}

async function handleFile(file) {
    loadingOverlay.classList.add('active');
    generatedHistory.clear();
    await new Promise(r => setTimeout(r, 600)); 

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            lastWorkbook = workbook;
            renderTable(workbook);
            loadingOverlay.classList.remove('active');
            document.querySelector('.drop-wrapper').style.display = 'none';
            resultArea.classList.remove('hidden');
        } catch (err) {
            console.error(err);
            loadingOverlay.classList.remove('active');
            alert(`èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${err.message}\nExcelãƒ•ã‚¡ã‚¤ãƒ«(.xlsx)ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
        }
    };
    reader.readAsArrayBuffer(file);
}

// --- Analysis Logic ---
function analyze(text) {
    text = (text || "").toString();
    
    // 1. Determine Type
    let typeScores = { A:0, B:0, C:0, D:0 };
    Object.keys(KEYWORDS.types).forEach(t => {
        KEYWORDS.types[t].forEach(w => { if(text.includes(w)) typeScores[t]++; });
    });
    let type = Object.keys(typeScores).reduce((a, b) => typeScores[a] > typeScores[b] ? a : b);
    if(Object.values(typeScores).every(v => v === 0)) type = 'D';

    // 2. Determine Context
    let posCount = 0;
    let negCount = 0;
    KEYWORDS.sentiment.positive.forEach(w => { if(text.includes(w)) posCount++; });
    KEYWORDS.sentiment.negative.forEach(w => { if(text.includes(w)) negCount++; });
    const context = (posCount >= negCount * 1.5 || (posCount > 0 && negCount === 0)) ? 'high' : 'low';

    return { type, context };
}

function getRandom(arr) {
    if (!arr || arr.length === 0) return "";
    return arr[Math.floor(Math.random() * arr.length)];
}

// --- Generation Logic (Grand Narrative) ---
function generate(analysis, category, slotKey = null, retryCount = 0) {
    const { type, context } = analysis;
    let text = "";

    // Common Parts
    const opener = getRandom(VOCAB.openers);
    const mod = getRandom(VOCAB.modifiers[context]);

    if (category === 'policy') {
        // [New Logic] Template based generation
        const templates = VOCAB.policy[context];
        const template = getRandom(templates);
        const focus = VOCAB.policy.focus[type];
        
        text = template
            .replace('{opener}', opener)
            .replace('{mod}', mod)
            .replace('{focus}', focus);

    } else if (category === 'long') {
        const templates = VOCAB.long_goal[context];
        const template = getRandom(templates);
        const focus = VOCAB.long_goal.focus[type];
        
        text = template
            .replace('{mod}', mod)
            .replace('{focus}', focus);

    } else if (category === 'short') {
        const templates = VOCAB.short_goal[context];
        const template = getRandom(templates);
        
        text = template
            .replace('{mod}', mod);

    } else if (category === 'goal') {
        // Individual Goal
        const topic = getRandom(VOCAB.contents[slotKey].topic);
        const end = getRandom(VOCAB.endings[`goal_${context}`]);
        
        if (context === 'high') text = `${topic}ã‚’${mod}${end}`;
        else text = `${mod}${topic}ã‚’${end}`;

    } else if (category === 'support') {
        // Individual Support
        const topic = getRandom(VOCAB.contents[slotKey].sup);
        const end = getRandom(VOCAB.endings[`sup_${context}`]);
        
        if (context === 'high') text = `${topic}ã‚’é€šã˜ã¦ã€${mod}${end}`;
        else text = `å¿…è¦ã«å¿œã˜${topic}ã‚’è¡Œã„ã€${mod}${end}`;
    }

    // Cleanup & Retry
    text = text.replace("  ", " ").trim();
    if (generatedHistory.has(text) && retryCount < 20) {
        return generate(analysis, category, slotKey, retryCount + 1);
    }
    generatedHistory.add(text);
    return text;
}

function renderTable(workbook) {
    tbody.innerHTML = '';
    generatedHistory.clear();
    let count = 0;

    workbook.SheetNames.forEach(sheetName => {
        if (sheetName.match(/è¨­å®š|ãƒã‚¹ã‚¿|config|list|ä¸€è¦§|Sheet/i)) return;

        const sheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        const fullText = json.map(row => row.join(' ')).join(' ');
        
        // Analyze
        const analysis = analyze(fullText);

        // Generate All Columns with Logic
        const policy = generate(analysis, 'policy');
        const longGoal = generate(analysis, 'long');
        const shortGoal = generate(analysis, 'short');
        
        const l_g = generate(analysis, 'goal', 'life');
        const l_s = generate(analysis, 'support', 'life');
        const w_g = generate(analysis, 'goal', 'work');
        const w_s = generate(analysis, 'support', 'work');
        const f_g = generate(analysis, 'goal', 'future');
        const f_s = generate(analysis, 'support', 'future');

        // Badge
        const badgeClass = analysis.context === 'high' ? 'badge-high' : 'badge-low';
        const badgeText = analysis.context === 'high' ? 'å®‰å®šãƒ»è‰¯å¥½' : 'æ”¯æ´ãƒ»èª²é¡Œ';

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="font-weight:bold; color:var(--text-main);">${sheetName}</td>
            <td>
                <div class="badge badge-${analysis.type}" style="margin-bottom:4px;">TYPE ${analysis.type}</div><br>
                <div class="badge ${badgeClass}">${badgeText}</div>
            </td>
            <td>${policy}</td>
            <td>${longGoal}</td>
            <td>${shortGoal}</td>
            <td class="col-life">${l_g}</td>
            <td class="col-life">${l_s}</td>
            <td class="col-work">${w_g}</td>
            <td class="col-work">${w_s}</td>
            <td class="col-future">${f_g}</td>
            <td class="col-future">${f_s}</td>
        `;
        tbody.appendChild(tr);
        count++;
    });
    document.getElementById('countDisplay').innerText = count;
}

function copyToClipboard() {
    let txt = "";
    const headers = Array.from(document.querySelectorAll('#resultTable thead th')).map(th => th.innerText);
    txt += headers.join('\t') + '\n';
    document.querySelectorAll('#resultTable tbody tr').forEach(tr => {
        const tds = Array.from(tr.children).map(td => td.innerText.replace(/\n/g,' '));
        txt += tds.join('\t') + '\n';
    });
    navigator.clipboard.writeText(txt).then(() => {
        const btn = document.getElementById('copyBtn');
        const original = btn.innerHTML;
        btn.innerHTML = "âœ… å®Œäº†";
        setTimeout(() => btn.innerHTML = original, 2000);
    });
}

function downloadCSV() {
    let csv = "";
    const headers = Array.from(document.querySelectorAll('#resultTable thead th')).map(th => `"${th.innerText}"`);
    csv += headers.join(',') + "\n";
    document.querySelectorAll('#resultTable tbody tr').forEach(tr => {
        const row = Array.from(tr.children).map(td => `"${td.innerText.replace(/"/g, '""')}"`);
        csv += row.join(',') + "\n";
    });
    const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
    const blob = new Blob([bom, csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'æ”¯æ´è¨ˆç”»_AIç”Ÿæˆæ¡ˆ_Ver6.csv';
    a.click();
}
</script>
</body>
</html>